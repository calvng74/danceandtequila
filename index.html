<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡Dance and Tequila! - Formulario de Comentarios con Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-green: #AFFF33;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }
        h1, h2, .form-label, button {
            font-family: 'Anton', sans-serif;
            letter-spacing: 0.05em;
        }
        .form-label {
            @apply mb-2 text-2xl font-bold text-white;
        }
        .form-input, .form-textarea, .form-select {
            @apply w-full p-3 bg-black border-2 border-gray-700 rounded-none text-white placeholder-gray-500 focus:outline-none focus:border-[var(--brand-green)] transition-colors;
        }
        .form-section {
            @apply bg-black p-6 md:p-8 border-2 border-[var(--brand-green)];
        }
        .rating-group {
            @apply flex flex-wrap items-center justify-center gap-2;
        }
        .rating-label {
            @apply w-12 h-12 flex items-center justify-center bg-gray-800 text-white rounded-none cursor-pointer transition-all duration-300 ease-in-out border-2 border-gray-700;
        }
        .rating-input:checked + .rating-label {
            @apply bg-[var(--brand-green)] text-black scale-110 shadow-lg;
            border-color: var(--brand-green);
        }
        .rating-input {
            @apply hidden;
        }
        .checkbox-label {
            @apply flex items-center justify-center text-center p-3 bg-gray-800 rounded-none cursor-pointer transition-colors hover:bg-gray-700 border-2 border-gray-700;
        }
        .checkbox-input:checked + .checkbox-label {
            @apply bg-[var(--brand-green)] text-black ring-0;
             border-color: var(--brand-green);
        }
        .checkbox-input {
            @apply hidden;
        }
        .submit-button {
             @apply w-full mt-4 py-4 px-6 bg-[var(--brand-green)] text-black font-bold text-2xl rounded-none shadow-lg transform hover:bg-white transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .loader {
            border: 4px solid #333;
            border-top: 4px solid var(--brand-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-white">
    <div class="min-h-screen bg-black flex items-center justify-center p-4">
        <div class="max-w-2xl w-full mx-auto space-y-8">

            <!-- Header -->
            <div class="text-center">
                <h1 class="text-6xl md:text-8xl font-black tracking-wider text-[var(--brand-green)]">
                    DANCE AND TEQUILA
                </h1>
                <p class="mt-2 text-xl text-gray-300 font-sans">¡QUEREMOS SABER TU OPINIÓN!</p>
            </div>

            <!-- Form -->
            <form id="feedbackForm" class="space-y-6">
                <!-- Overall Experience -->
                <div class="form-section">
                    <label class="form-label block text-center">1. EXPERIENCIA GENERAL</label>
                    <div class="rating-group mt-4">
                        <div class="text-gray-400 mr-2">MALA</div>
                        <input type="radio" id="rate-1" name="overall_rating" value="1" class="rating-input"><label for="rate-1" class="rating-label">1</label>
                        <input type="radio" id="rate-2" name="overall_rating" value="2" class="rating-input"><label for="rate-2" class="rating-label">2</label>
                        <input type="radio" id="rate-3" name="overall_rating" value="3" class="rating-input"><label for="rate-3" class="rating-label">3</label>
                        <input type="radio" id="rate-4" name="overall_rating" value="4" class="rating-input"><label for="rate-4" class="rating-label">4</label>
                        <input type="radio" id="rate-5" name="overall_rating" value="5" class="rating-input"><label for="rate-5" class="rating-label">5</label>
                        <div class="text-gray-400 ml-2">¡INCREÍBLE!</div>
                    </div>
                </div>
                <!-- What you liked -->
                <div class="form-section">
                    <label for="liked" class="form-label">2. ¿QUÉ FUE LO MEJOR?</label>
                    <p class="text-gray-400 mb-4 text-sm font-sans">DJs, momentos, o cualquier cosa que hayas disfrutado.</p>
                    <textarea id="liked" name="liked" rows="4" class="form-textarea" placeholder="Ej: Los visuales, el set de cierre, la selección de tequila..."></textarea>
                </div>
                <!-- What was missing -->
                <div class="form-section">
                    <label for="missing" class="form-label">3. ¿QUÉ PODRÍAMOS MEJORAR?</label>
                    <p class="text-gray-400 mb-4 text-sm font-sans">¿Faltó algo? ¿Problemas con el sonido, las filas, el lugar?</p>
                    <textarea id="missing" name="missing" rows="4" class="form-textarea" placeholder="Ej: Más agua, sets más largos, otra música en la sala 2..."></textarea>
                </div>
                <!-- Music Genre -->
                <div class="form-section">
                    <label class="form-label">4. ¿MÁS DE QUÉ GÉNEROS?</label>
                     <p class="text-gray-400 mb-4 text-sm font-sans">Selecciona todos los que apliquen.</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <input type="checkbox" id="genre-house" name="genre" value="house" class="checkbox-input"><label for="genre-house" class="checkbox-label">HOUSE</label>
                        <input type="checkbox" id="genre-techno" name="genre" value="techno" class="checkbox-input"><label for="genre-techno" class="checkbox-label">TECHNO</label>
                        <input type="checkbox" id="genre-trance" name="genre" value="trance" class="checkbox-input"><label for="genre-trance" class="checkbox-label">TRANCE</label>
                        <input type="checkbox" id="genre-dnb" name="genre" value="dnb" class="checkbox-input"><label for="genre-dnb" class="checkbox-label">DRUM & BASS</label>
                        <input type="checkbox" id="genre-dubstep" name="genre" value="dubstep" class="checkbox-input"><label for="genre-dubstep" class="checkbox-label">DUBSTEP</label>
                        <input type="checkbox" id="genre-other" name="genre" value="other" class="checkbox-input"><label for="genre-other" class="checkbox-label">OTRO</label>
                    </div>
                </div>
                <!-- Likelihood to return -->
                <div class="form-section">
                    <label class="form-label block text-center">5. ¿RECOMENDARÍAS EL EVENTO?</label>
                    <div class="rating-group mt-4">
                        <div class="text-gray-400 mr-2">POCO PROBABLE</div>
                        <input type="radio" id="rec-1" name="recommend" value="1" class="rating-input"><label for="rec-1" class="rating-label">1</label>
                        <input type="radio" id="rec-2" name="recommend" value="2" class="rating-input"><label for="rec-2" class="rating-label">2</label>
                        <input type="radio" id="rec-3" name="recommend" value="3" class="rating-input"><label for="rec-3" class="rating-label">3</label>
                        <input type="radio" id="rec-4" name="recommend" value="4" class="rating-input"><label for="rec-4" class="rating-label">4</label>
                        <input type="radio" id="rec-5" name="recommend" value="5" class="rating-input"><label for="rec-5" class="rating-label">5</label>
                        <div class="text-gray-400 ml-2">MUY PROBABLE</div>
                    </div>
                </div>
                <!-- Submit Button -->
                <div id="submit-container">
                    <button type="submit" class="submit-button">
                        ENVIAR COMENTARIOS
                    </button>
                </div>
            </form>
            
            <!-- Gemini Section -->
            <div id="geminiSection" class="hidden text-center form-section">
                <h2 class="text-4xl font-bold text-[var(--brand-green)]">¡GRACIAS!</h2>
                <p class="mt-2 text-gray-300 font-sans">Tus comentarios son valiosos. ¿Quieres ver ideas para el próximo evento?</p>
                <button id="generateIdeasBtn" class="submit-button">✨ GENERAR IDEAS</button>
                <div id="loader" class="hidden loader"></div>
                <div id="geminiResult" class="mt-6 text-left p-4 bg-black/50 rounded-none whitespace-pre-wrap font-sans"></div>
            </div>

        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const form = document.getElementById('feedbackForm');
        const geminiSection = document.getElementById('geminiSection');
        const generateIdeasBtn = document.getElementById('generateIdeasBtn');
        const loader = document.getElementById('loader');
        const geminiResult = document.getElementById('geminiResult');

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase sign-in error:", error);
                }
            }
        });

        // --- Form Submission Handler ---
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            // --- Collect Form Data ---
            const formData = new FormData(form);
            const data = {
                overallRating: formData.get('overall_rating'),
                liked: formData.get('liked'),
                missing: formData.get('missing'),
                genres: formData.getAll('genre'),
                recommend: formData.get('recommend'),
                createdAt: serverTimestamp() // Add a timestamp
            };

            // --- Save to Firestore ---
            try {
                const feedbackCollection = collection(db, `artifacts/${appId}/public/data/feedback`);
                await addDoc(feedbackCollection, data);
                console.log("Feedback saved successfully!");
            } catch (error) {
                console.error("Error saving feedback to Firestore:", error);
            }

            // --- UI Update ---
            form.style.display = 'none';
            geminiSection.style.display = 'block';
            window.scrollTo(0, 0);
        });

        // --- Gemini API Call Handler ---
        generateIdeasBtn.addEventListener('click', async () => {
            const likedText = document.getElementById('liked').value;
            const missingText = document.getElementById('missing').value;
            
            generateIdeasBtn.disabled = true;
            loader.style.display = 'block';
            geminiResult.innerHTML = '';

            const prompt = `Basado en los siguientes comentarios de un asistente a un evento de música electrónica llamado "Dance and Tequila!", genera 3 ideas creativas y detalladas para el próximo evento.

            Cosas que le gustaron al asistente: "${likedText}"
            Cosas que cree que podrían mejorar o faltaron: "${missingText}"

            Para cada idea, sugiere un tema, posibles DJs o estilos musicales, y una característica única relacionada con el tequila. Formatea la respuesta de manera atractiva usando markdown con títulos y listas.`;

            try {
                const generatedText = await callGemini(prompt);
                geminiResult.innerText = generatedText;
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                geminiResult.innerText = 'Lo sentimos, ocurrió un error al generar las ideas. Por favor, inténtalo de nuevo más tarde.';
            } finally {
                generateIdeasBtn.disabled = false;
                loader.style.display = 'none';
            }
        });

        // --- Gemini API Fetch Function ---
        async function callGemini(prompt, maxRetries = 3) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Invalid response structure from API');
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
            throw new Error('Failed to get response from API after multiple retries.');
        }
    </script>
</body>
</html>
